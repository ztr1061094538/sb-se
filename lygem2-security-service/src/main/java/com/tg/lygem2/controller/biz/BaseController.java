package com.tg.lygem2.controller.biz;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.tg.lygem2.service.biz.BridgService;
import com.tg.lygem2.service.biz.MenuTooleService;
import com.tg.lygem2.service.biz.RoleToolService;
import com.tg.lygem2.service.biz.UserToolService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

import javax.servlet.http.HttpServletRequest;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

/**
 * @program: bmp
 * @author: jikai.sun
 * @create: 2018-10-10
 **/
@Slf4j
public class BaseController {

    @Autowired
    protected ObjectMapper objectMapper;

    @Autowired
    protected UserToolService userService;

    @Autowired
    protected BridgService bridgService;

    @Autowired
    protected RoleToolService roleToolService;

    @Autowired
    protected MenuTooleService menuTooleService;

    @Autowired
    protected BCryptPasswordEncoder bCryptPasswordEncoder;

    public List<String> getAuthentication() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        Collection<? extends GrantedAuthority> authorities = authentication.getAuthorities();
        List<String> list = new ArrayList<>();
        for (GrantedAuthority grantedAuthority : authorities) {
            log.info("权限列表：{}", grantedAuthority.getAuthority());
            list.add(grantedAuthority.getAuthority());
        }
        return list;
    }


    public static final String getDomainName(HttpServletRequest request) {
        String domainName = null;

        String serverName = request.getRequestURL().toString();
        if (serverName == null || serverName.equals("")) {
            domainName = "";
        } else {
            serverName = serverName.toLowerCase();
            serverName = serverName.substring(7);
            final int end = serverName.indexOf("/");
            serverName = serverName.substring(0, end);
            final String[] domains = serverName.split("\\.");
            int len = domains.length;
            if (len > 3) {
                domainName = domains[len - 4] +  "." + domains[len - 3] + "." + domains[len - 2] + "." + domains[len - 1];
            } else if (len <= 3 && len > 1) {
                domainName = "." + domains[len - 2] + "." + domains[len - 1];
            } else {
                domainName = serverName;
            }
        }

        if (domainName != null && domainName.indexOf(":") > 0) {
            String[] ary = domainName.split("\\:");
            domainName = ary[0];
        }
        return domainName;
    }
}